---
title: "Status of childhood immunization"
date: "September 2025"
date-format: "MMMM YYYY"
format:
   typst:
      template-partials:
         - typst-template.typ
         - typst-show.typ
params:
  state: maine
execute:
  echo: false
  message: false
  warning: false
  fig-align: center
---

```{r}
#| output: false
library(tidyverse)
library(glue)
library(sf)
library(janitor)

source("R/charts.R")

state <- params$state
state_title <- gsub(" Of ", " of ", str_to_title(state))

total_measles_cases <- read_csv("data-clean/total_measles_cases.csv")

mmr_coverage_final <- read_csv("data-clean/mmr_coverage_final.csv")

state_policies <- read_csv("data-clean/state_policies_final.csv") |>
  filter(state == state_title) |>
  filter(!(is.na(bill_number)))

dtap_coverage_final <- read_csv("data-clean/dtap_coverage_final.csv")

exemption_policies <- read_csv(
  "data-clean/non_medical_exemption_policies_final.csv"
)

exemption <- read_csv("data-clean/non_medical_exemption.csv")

if (state_title == "Maine") {
  year_filter <- "2023-24"
  year_filter_before <- "2022-23"
} else if (state_title == "Montana") {
  year_filter <- "2020-21"
  year_filter_before <- "2019-20"
} else if (state_title == "New York") {
  year_filter <- "2018-19"
  year_filter_before <- "2017-18"
} else if (state_title == "California") {
  year_filter <- "2016-17"
  year_filter_before <- "2015-16"
} else {
  year_filter <- "2024-25"
  year_filter_before <- "2023-24"
}
exemption_policies_state <- exemption_policies |> filter(State == state_title)
exemption_state <- exemption |>
  filter(geography == state_title) |>
  filter(school_year == year_filter)
exemption_state_year_before <- exemption |>
  filter(geography == state_title) |>
  filter(school_year == year_filter_before)
exemption_us <- exemption |>
  filter(geography == "U.S. Median") |>
  filter(school_year == "2024-25")
if (nrow(exemption_us) == 0) {
  stop(glue("Missing US in exemption dataset."))
}
first_box <- exemption_policies_state |>
  pull("Personal Exemption") |>
  toupper()
second_box <- exemption_policies_state |>
  pull("Religious Exemption") |>
  toupper()
third_box <- exemption_state |>
  pull("estimate_percent") |>
  round(1)
third_box_label <- paste0(third_box, "%")
fourth_box <- exemption_us |>
  pull("estimate_percent") |>
  round(1)
fourth_box_label <- paste0(fourth_box, "%")
third_box_before <- exemption_state_year_before |> pull("estimate_percent")

is_universal_purchaser <- read_csv("data-clean/universal_purchase_final.csv") |>
  filter(State == state_title) |>
  pull("Universal Purchase") |>
  toupper()

health_spending <- read_csv("data-clean/health_spending_final.csv")
health_spending_state <- health_spending |>
  filter(State == state_title)
if (nrow(health_spending_state) == 0) {
  stop(glue("Missing state {state} in health spending dataset."))
}
rank_spending <- health_spending_state |>
  pull("Rank") |>
  ordinal()
spending_state <- health_spending_state |>
  pull("Public Health Funding Per Capita ($)") |>
  round()
spending_us <- health_spending |>
  filter(State == "United States") |>
  pull("Public Health Funding Per Capita ($)") |>
  round()
spending_state_label <- paste0("$", spending_state)
spending_us_label <- paste0("$", spending_us)

us_states <-
  read_rds("data-clean/us_states.rds")

population_by_state <-
  read_rds("data-clean/population_by_state.rds")

df <- left_join(us_states, total_measles_cases, by = c("name" = "state"))

priority_years <- c(
  "2024-25",
  "2023-24",
  "2022-23",
  "2021-22",
  "2020-21",
  "2019-20"
)

df_mmr_coverage_final <- mmr_coverage_final |>
  select(geography, school_year, estimate_percent) |>
  filter(school_year %in% priority_years) |>
  mutate(
    estimate_percent = readr::parse_number(as.character(estimate_percent))
  ) |>
  group_by(geography, school_year) |>
  summarise(
    estimate_percent = first(
      estimate_percent[!is.na(estimate_percent)],
      default = NA_real_
    ),
    .groups = "drop"
  ) |>
  pivot_wider(
    names_from = school_year,
    values_from = estimate_percent,
    values_fill = NA_real_
  ) |>
  mutate(
    estimate_percent = coalesce(
      `2024-25`,
      `2023-24`,
      `2022-23`,
      `2021-22`,
      `2020-21`,
      `2019-20`
    ),
    school_year = case_when(
      !is.na(`2024-25`) ~ "2024-25",
      !is.na(`2023-24`) ~ "2023-24",
      !is.na(`2022-23`) ~ "2022-23",
      !is.na(`2021-22`) ~ "2021-22",
      !is.na(`2020-21`) ~ "2020-21",
      !is.na(`2019-20`) ~ "2019-20",
      TRUE ~ NA_character_
    )
  ) |>
  filter(!is.na(estimate_percent)) |>
  select(geography, school_year, estimate_percent)

df_mmr <- left_join(
  df_mmr_coverage_final,
  population_by_state,
  by = c("geography" = "state")
)

mmr_line_df <- mmr_coverage_final |>
  select(geography, school_year, estimate_percent)

df_dtap_coverage_final <- dtap_coverage_final |>
  select(geography, year, estimate_percent) |>
  filter(year == "2023")

df_dtap <- left_join(
  df_dtap_coverage_final,
  population_by_state,
  by = c("geography" = "state")
)

dtap_line_df <- dtap_coverage_final |>
  select(geography, year, estimate_percent)

measles_cases_updated_date <-
  read_rds("data-clean/measles_cases_updated_date.rds")
```

```{r}
#| output: asis
vals <- df_mmr |>
  filter(geography %in% c(state_title, "United States"))
vals_state <- vals |> filter(geography == state_title) |> pull(estimate_percent)
vals_national <- vals |>
  filter(geography == "United States") |>
  pull(estimate_percent)
diff <- round(vals_national - vals_state)

if (diff > 0) {
  label_national_comparison <- "above"
} else if (diff < 0) {
  label_national_comparison <- "below"
} else {
  label_national_comparison <- "similar to"
}

# some states have some missing data here
if (
  !(state_title %in%
    c(
      "Montana",
      "West Virginia",
      "Maine",
      "California",
      "New York",
      "Connecticut"
    ))
) {
  if (third_box > fourth_box) {
    label_median_comparison <- "higher"
  } else if (third_box < fourth_box) {
    label_median_comparison <- "lower"
  } else {
    label_median_comparison <- "about the same"
  }
  sentence_median_comparison <- glue(
    "- {state_title}'s non-medical exemption rate among kindergartners is {label_median_comparison} than the U.S. median.\n\n"
  )
} else {
  sentence_median_comparison <- glue(
    "- {state_title} does not allow personal or religious exemptions.\n\n"
  )
}

if (state_title == "New Hampshire") {
  sentence_mmr <- ""
} else {
  sentence_mmr <- glue(
    "- State-level immunization coverage in {state_title} for MMR vaccination is {label_national_comparison} national levels.\n\n"
  )
}

if (spending_state >= spending_us) {
  label_spending_comparison <- "higher"
} else {
  label_spending_comparison <- "lower"
}

n_cases_measles <- df |>
  filter(name == state_title) |>
  pull(total)

if (n_cases_measles == 1) {
  measles_cases_text <- "case"
} else {
  measles_cases_text <- "cases"
}

print(glue(
  "This brief illustrates the current status of childhood immunization in {state_title} and is intended to inform state-level policy decisions and priorities. Takeaways include:"
))
cat("\n\n")
cat(
  sentence_mmr,
  sentence_median_comparison,
  glue(
    "- State-level per capita public health spending is {label_spending_comparison} than the national rate.\n\n"
  ),
  glue(
    "- {state_title} has reported {n_cases_measles} {measles_cases_text} of measles since January 1, 2025."
  )
)
```

```{=typst} 
#blueline()
```

## Vaccination coverage

```{=typst}
#v(3pt)
```

```{r}
#| output: asis
print(glue(
  "Maintaining sufficient vaccination coverage is critical for establishing community protection. The charts below demonstrate how coverage for two critical vaccines has changed over time in {state_title} and how it compares to neighboring states, national rates, and Healthy People 2030 (HP2030) targets."
))
```


<div style="background-color: #F8F8F8;">

```{=typst}
#chart-title("Proportion of 2-year-olds fully protected with DTaP vaccines")
```

::: {layout="[[1,1]]"}

```{r}
dtap_line_df |> dtap_vaccination_over_time_chart_bar(state_title)
```

```{r}
df_dtap |> dtap_vaccination_comparison_chart(df, state_title)
```

:::

```{r}
vals <- dtap_line_df |>
  filter(geography == state_title, year %in% c(2022, 2023))
vals_2022 <- vals |> filter(year == 2022) |> pull(estimate_percent)
vals_2023 <- vals |> filter(year == 2023) |> pull(estimate_percent)
diff <- round(vals_2023 - vals_2022)

if (diff > 0) {
  label_yoy_comparison <- "more"
} else if (diff < 0) {
  label_yoy_comparison <- "fewer"
} else {
  label_yoy_comparison <- "approximately the same proportion of"
}

coverage_state <- dtap_line_df |>
  filter(geography == state_title) |>
  filter(year == 2023) |>
  pull(estimate_percent) |>
  round()
if (coverage_state < 90) {
  label_target <- "below"
} else {
  label_target <- "above"
}

is_above_us <- df_dtap |>
  filter(geography %in% c(state_title, "United States")) |>
  summarise(
    higher = estimate_percent[geography == state_title] >
      estimate_percent[geography == "United States"]
  ) |>
  pull(higher)
if (is_above_us) {
  label_coverage_us <- "higher"
} else {
  label_coverage_us <- "lower"
}

text_content <- glue(
  "In 2023, {label_yoy_comparison} 2-year-olds were fully vaccinated against diphtheria, tetanus, and pertussis (received all four doses of DTaP) in {state_title} compared to the previous year. Coverage in {state_title} is {label_target} the HP2030 target of 90%."
)
```

```{=typst}
#box(inset: 10pt)[
  #text("`r text_content`")
  #source("Source: ChildVaxView")
]
```

</div>

```{=typst} 
#pagebreak()
```

<div style="background-color: #F8F8F8;">

```{r}
if (state_title == "New Hampshire") {
  chart_title <- "Proportion of childcare attendees protected with MMR vaccines"
} else {
  chart_title <- "Proportion of kindergartners protected with MMR vaccines"
}
```

```{=typst}
#chart-title("`r chart_title`")
```

::: {layout="[[1,1]]"}

```{r}
mmr_line_df |> mmr_vaccination_over_time_chart_bar(state_title)
```


```{r}
df_mmr |> mmr_vaccination_comparison_chart(df, state_title)
```

:::

```{r}
is_decreasing_yoy <- mmr_coverage_final |>
  filter(
    geography == state_title,
    school_year %in% c("2023-24", "2024-25")
  ) |>
  summarise(
    decrease = estimate_percent[school_year == "2024-25"] <
      estimate_percent[school_year == "2023-24"]
  ) |>
  pull(decrease)

vals <- mmr_coverage_final |>
  filter(
    geography == state_title,
    school_year %in% c("2023-24", "2024-25")
  )
vals_2024_25 <- vals |>
  filter(school_year == "2024-25") |>
  pull(estimate_percent)
vals_2023_24 <- vals |>
  filter(school_year == "2023-24") |>
  pull(estimate_percent)
diff <- round(vals_2024_25 - vals_2023_24)

is_lower_us <- mmr_coverage_final |>
  filter(
    geography %in% c(state_title, "United States"),
    school_year == "2024-25"
  ) |>
  summarise(
    lower_than_us = estimate_percent[geography == state_title] <
      estimate_percent[geography == "United States"]
  ) |>
  pull(lower_than_us)

value <- mmr_coverage_final |>
  filter(
    geography == state_title,
    school_year == "2024-25"
  ) |>
  pull(estimate_percent)
is_below_target <- value < 95

# some states have some missing data which prevent us to display default text
if (state_title %in% c("West Virginia", "Montana")) {
  text_content <- glue(
    "{state_title} does not have complete data for all school years, which prevents us from showcasing them here."
  )
  source <- "Source: SchoolVaxView"
} else if (state_title == "New Hampshire") {
  text_content <- "Measles, mumps, and rubella (MMR)  vaccination coverage among kindergartners is not available for New Hampshire. The coverage presented in the chart above represents the percentage of 19-59-month-olds in childcare who have received MMR vaccination."
  source <- "Source: New Hampshire DHHS"
} else {
  if (diff > 0) {
    label_yoy_comparison <- "a higher"
  } else if (diff < 0) {
    label_yoy_comparison <- "a lower"
  } else {
    label_yoy_comparison <- "approximately the same"
  }

  if (is_lower_us) {
    label_coverage <- "lower"
  } else {
    label_coverage <- "higher"
  }

  if (is_below_target) {
    label_target <- "falls short of"
  } else {
    label_target <- "exceeds"
  }

  text_content <- glue(
    "In 2024, {label_yoy_comparison} proportion of kindergarteners completed the measles, mumps, and rubella (MMR) vaccine in {state_title} compared to the previous year. Coverage in {state_title} {label_target} the HP2030 target of 95%."
  )
  source <- "Source: SchoolVaxView"
}
```

```{=typst}
#box(inset: 10pt)[
  #text("`r text_content`")
  #source("`r source`")
]
```

</div>

```{=typst} 
#blueline()
```

## Vaccination exemptions

```{=typst}
#box(inset: 10pt)[
  Many states allow children attending public school to receive vaccination exemptions for religious reasons or for personal reasons, sometimes referred to as "philosophical exemptions." Higher rates of non-medical exemptions have been linked with increased disease transmission.
]
```

<div style="background-color: #F8F8F8;">

```{r}
if (
  !(state_title %in%
    c("Maine", "West Virginia", "Puerto Rico", "New York", "California"))
) {
  variation <- (third_box - third_box_before) / third_box_before
  if (abs(variation) <= 0.1) {
    variation_text <- "is similar to"
  } else if (variation > 0.0) {
    variation_text <- "is a slight increase from"
  } else {
    variation_text <- "is a slight decrease from"
  }
  additional_details <- exemption_policies_state |>
    pull(
      "Additional Details on Exemption Exceptions & Educational Requirements"
    ) |>
    as.character()
  if (is.na(additional_details)) {
    additional_details <- ""
    heading_ad <- ""
  } else {
    heading_ad <- "Additional details on exemption requirements:"
  }
  text_content <- glue(
    "{state_title}'s rate of non-medical exemptions among kindergartners during the {year_filter} school year {variation_text} the state's {year_filter_before} rate."
  )
} else {
  additional_details <- exemption_policies_state |>
    pull(
      "Additional Details on Exemption Exceptions & Educational Requirements"
    ) |>
    as.character()
  if (is.na(additional_details)) {
    additional_details <- ""
    heading_ad <- ""
  } else {
    heading_ad <- "Additional details on exemption requirements:"
  }
  third_box_label <- "NA"
  text_content <- ""
}
```

```{=typst}
#box(
  inset: 1em,
  [
    #grid(
      columns: (1fr, 1fr, 1fr, 1fr),
      gutter: 1em,
      [#status-boxes(top-text: "Allows personal exemptions?", bottom-text: "`r first_box`")],
      [#status-boxes(top-text: "Allows religious exemptions?", bottom-text: "`r second_box`")],
      [#status-boxes(top-text: "Non-medical exemptions — state", bottom-text: "`r third_box_label`")],
      [#status-boxes(top-text: "Non-medical exemptions — US median", bottom-text: "`r fourth_box_label`")]
    )
  ]
)
#box(inset: 10pt)[
  #text("`r text_content`") \ \
  #text(weight: "bold", "`r heading_ad`") \
  #text("`r additional_details`")
  #source("Source: NCSL, SchoolVaxView")
]
```

</div>

```{=typst}
#pagebreak()
#blueline()
```

## PUBLIC HEALTH SPENDING

<div style="background-color: #F8F8F8;">

```{r}
if (state_title == "District of Columbia") {
  text_content <- glue(
    "Low levels of public health spending are thought to contribute to suboptimal immunization rates."
  )
} else {
  text_content <- glue(
    "Low levels of public health spending are thought to contribute to suboptimal immunization rates. Nationally, {state_title} ranks {rank_spending} in public health spending."
  )
}
```

```{=typst}
#box(inset: 10pt)[
  #grid(
    columns: (70%, 1fr),
    column-gutter: 8pt,
    align: horizon,
    [#text("`r text_content`")],

    stack(
      dir: ttb,
      spacing: 6pt,
      align(center + horizon)[
        #text(weight: "bold", size: 10pt)[State dollars dedicated to public health per capita (2022-23)]
      ],
      grid(
        columns: (auto, auto, auto),
        column-gutter: 12pt,
        row-gutter: 6pt,
        align(center + horizon)[State],
        [],
        align(center + horizon)[National],
        ..connected-boxes(text1: "`r spending_state_label`", text2: "`r spending_us_label`")
      )
    )
  )
  #source("Source: America's Health Rankings")
]
```

</div>

```{=typst} 
#blueline()
```

## UNIVERSAL VACCINE PURCHASING

<div style="background-color: #F8F8F8;">

```{=typst}
#box(inset: 10pt)[
  #grid(
    columns: (70%, 1fr),
    column-gutter: 20pt,
    align: horizon,
    [In states with Universal Purchase programs, the state government purchases all recommended vaccines for all children, regardless of insurance status. These initiatives can help to address disparities in vaccine coverage and support equitable vaccine access.],
    status-boxes(top-text: "Universal Purchaser?", bottom-text: "`r is_universal_purchaser`")
  )
  #source("Source: AIM")
]
```

</div>

```{=typst} 
#blueline()
```

## SUPPORT FOR IMMUNIZATION

```{r}
#| output: asis
if (nrow(state_policies) == 1) {
  cat(
    "The state legislature recently introduced a bill that would affect statewide childhood vaccination. The arrow below indicates whether the bill would strengthen (↑) or weaken (↓) vaccine safety nets.\n"
  )
} else {
  cat(
    "Strong policy commitment to immunization is critical for effective vaccination programs. The state legislature has recently introduced several bills that would affect state-wide childhood vaccination, a selection of which are described below. The arrows below indicate whether these bills would strengthen (↑) or weaken (↓) vaccine safety nets.\n"
  )
}
```



```{r}
# here we dynamically write Typst code,
# because the number of element depends
# on the data
typst_list <- state_policies |>
  mutate(
    arrow = ifelse(
      bill_valency == "Good",
      "up-arrow.png",
      "down-arrow.png"
    ),
    list_item = glue(
      '#list(marker: image("assets/{arrow}", width: 23pt))[',
      "{bill_number} ({bill_status}) – {text_description}]"
    )
  ) |>
  pull(list_item)
typst_list <- gsub("\\$", "\\\\\\$", typst_list)

typst_code <- glue(
  "box(inset: 10pt)[\n",
  '{paste(typst_list, collapse = "\n")}\n]',
  .trim = FALSE
)

# then we save that dynamic Typst code, and read it in Typst right after
writeLines(typst_code, "state_policies.typ")
```

<div style="background-color: #F8F8F8;">

```{=typst}
#let policies = read("state_policies.typ")
#eval(policies) // convert a string into actual typst code
#box(inset: 10pt)[#source("Source: AIM, LegiScan, NCSL")]
```

</div>

```{=typst} 
#pagebreak()
#blueline()
```

## DISEASE STATUS

```{r}
text_content <- glue(
  "Measles outbreaks can indicate insufficient vaccination coverage within a population. Disease may spread across state borders when vaccine coverage is low. The map below visualizes the number of measles cases reported in {state_title} and neighboring states between January 1, 2025 and {measles_cases_updated_date}."
)
```

<div style="background-color: #F8F8F8;">

::: {layout="[[1,1]]"}

```{=typst} 
#box(inset: 10pt)[
    #align(horizon)[#text("`r text_content`")]
]
```

```{r}
#| fig-height: 4
#| fig-width: 6
df |> measles_map(state_title)
```

```{=typst} 
#source("Source: U.S. Measles Tracker, IVAC.")
```

:::

</div>

```{=typst} 
#box(
  inset: 1em,
  fill: rgb("#002D72"),
  [
    #grid(
      columns: (1fr, 10fr),
      gutter: 0.1em,
      align: horizon,
      [#image("assets/coins.svg")],
      [#text(
        font: "Gentona",
        size: 11pt,
        fill: white
      )[Vaccines can help prevent expensive disease outbreaks. A 2018–19 measles outbreak in Washington was estimated to cost #text(fill: rgb("#f1c400"))[US\$47,479] per case for both direct medical and public health response expenses.]]
    )
    #place(
      bottom + right,
      dy: 3pt,
      source(color: white, "Source: Pike, 2022")
    )
  ]
)
```

```{=typst} 
#blueline()
```

## DATA SOURCES

```{r}
if (state_title == "New Hampshire") {
  source_mmr <- "- New Hampshire Department of Health and Human Services. Immunization Guidance for Child Care. Retrieved from https://www.dhhs.nh.gov/programs-services/disease-prevention/nh-immunization-program/immunization-guidance-child-care. Accessed September 2025"
} else {
  source_mmr <- "- MMR: CDC, SchoolVaxView Interactive! https://www.cdc.gov/schoolvaxview/data/index.html. MMR, States, School Years 2021-22, 2022-23, 2023-24, 2024-25. Updated July 2025."
}
```

```{=typst}
#show list: set block(spacing: 0.5em) // reduce line height
#set text(size: 9pt) // reduce all text font size
```

Vaccination coverage:

- DTaP: CDC, ChildVaxView Interactive! https://www.cdc.gov/childvaxview/about/interactive-reports.html. DTaP, ≥ 4 Doses, States/Local Areas, Birth Years/Cohorts 2017–2021, Age 24 months. Updated Aug 2024. 

```{r}
#| output: asis
cat(source_mmr, "\n\n")
```

Vaccination exemptions:

- Status: NCSL, State Non-Medical Exemptions From School Immunization Requirements. https://www.ncsl.org/health/state-non-medical-exemptions-from-school-immunization-requirements. Updated July 2025.
Rates: CDC, SchoolVaxView Interactive! https://www.cdc.gov/schoolvaxview/data/index.html. Exemption – Non-Medical Exemption, States, School Years 2023-24 and 2024-25. Updated July 2025.

Public health spending:

- Public Health Funding in United States, America's Health Rankings, United Health Foundation. https://www.americashealthrankings.org/explore/measures/PH_funding. Accessed July 2025.

Universal vaccine purchasing:

- Association of Immunization Managers, Policy Maps – Universal Vaccine Purchase Program. https://www.immunizationmanagers.org/resources/aim-policy-maps/. Updated April 2025.

Support for immunization:

- Association of Immunization Managers, Legislative Round-ups. https://www.immunizationmanagers.org/resources-toolkits/immunization-program-policy-toolkit/legislative-round-ups/. 
LegiScan. https://legiscan.com/. Accessed July 2025.
- NCSL State Public Health Legislation Database. https://www.ncsl.org/health/state-public-health-legislation-database. Accessed Sept 2025.

Disease status:

- International Vaccine Access Center, U.S. Measles Tracker. https://publichealth.jhu.edu/ivac/resources/us-measles-tracker. Accessed July 22, 2025.

Measles outbreak cost:

- Pike J, Melnick A, Gastañaduy PA, et al. Societal Costs of a Measles Outbreak. Pediatrics. 2021;147(4):e2020027037. doi:10.1542/peds.2020-027037

*Note: The high-level data included in this report do not reflect statewide variation in vaccination coverage or disease status. Further, state reporting policies may limit data completeness. For any data-related questions, please contact ivac@jh.edu.*
